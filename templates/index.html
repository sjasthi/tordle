{% extends 'base.html' %} {% block content %}
<div id="image" class="center">
    <section class="game">
        {%for i in range(1,(params.attempt + 1))%}
        <div id="guess{{i}}" class="guess" data-letters="" style="grid-template-columns: repeat({{params.length}}, 1fr)">
            {%for j in range(1,(params.length + 1))%}
            <div class="guess__tile" id="guess{{i}}Tile{{j}}"></div>
            {%endfor%}
        </div>
        {%endfor%}
    </section>
    <br>
    <div class="content-section">
        {% if params and params.language == 'Telugu' %} {% if words.wordCount
        <params.attempt and words.status=='PROCESS' %} <form action="{{ url_for('home')}}" method="post">
            <fieldset class="form-group">
                <input id="input" class="form-control form-control-lg" onblur="this.focus()" autofocus type="text" onKeyDown="teluguHandle" autocomplete="off" name="word">
            </fieldset>
            <div class="form-group">
                <button type="submit" id="submit" onclick="onClickTelugu()" class="btn btn-outline-info"> SUBMIT</button> {% if words.word_len_test==False %}
                <div class="requirements">
                    Must be a valid Word!
                </div>
                {% endif %}
            </div>
            </form>
            {%else%}
            <button type="submit" id="again" onclick="document.getElementById('go').click()" class="btn btn-outline-info">PLAY AGAIN</button> {%if words.status=='SUCCESS' %}
            <button type="submit" id="share" data-toggle="modal" data-target="#ModalShare" onclick="screenshot()" class="btn btn-outline-info">SHARE</button> {%endif%} {%endif%} {% else %}
            <fieldset class="form-group">
                <input id="input" maxlength="{{params.length}}" class="form-control form-control-lg" onblur="this.focus()" autofocus type="text" onKeyDown="handleInput" autocomplete="off" name="word">
            </fieldset>
            <div id="share_btn" class="form-group">
                <button id="submit" onclick="onClick()" name="submit" class="btn btn-outline-info"> SUBMIT</button>
            </div>
            {% endif %}
            <!-- start image Modal -->
            <div class="modal fade" id="ModalShare" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
                <div class="modal-dialog" role="document">

                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLongTitle">Screenshot Share</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
                        </div>
                        <div id="canvas" class="modal-body">
                        </div>
                        <div class="modal-footer">
                            <a id="download" download="myImage.jpg" class="btn btn-outline-info" href="" onclick="download_img(this);">Download</a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end image Modal -->
    </div>
</div>

<script type="text/javascript">
    const lettersPattern = /[a-z]/; // /^[A-Za-z][A-Za-z0-9]*$/;
    let currentGuessCount = 1;
    let currentGuess = document.querySelector('#guess' + currentGuessCount);
    let words = JSON.parse('{{words | tojson | safe}}');
    console.log(words)
    let solutionWord = words["solution"]
    let guess_word = words["result"]
    let params = JSON.parse('{{params | tojson | safe}}');
    console.log(params)
    let word_size = params["length"]
    let total_rol = params["attempt"]
    var canvas_save = null;
    // Screenshot img
    const screenshot = () => {
        html2canvas(document.getElementById('image')).then(function(canvas) {
            document.getElementById('canvas').appendChild(canvas);
            canvas_save = canvas;
        });
    }

    // download img
    //  window.onload = init();
    // var canvas = document.getElementById("canvas");

    //   var ctx = canvas.getContext("2d");
    //  var ox = canvas.width;
    // var oy = canvas.height;
    // ctx.font = "42px serif";
    // ctx.textAlign = "center";
    //ctx.textBaseline = "middle";
    //ctx.fillStyle = "#800";
    // ctx.fillRect(ox, oy, ox, oy);

    const download_img = (el) => {
        var image = canvas_save.toDataURL("image/jpg").replace('image/jpeg', 'image/octet-stream');
        el.href = image;
    };

    const teluguHandle = () => {
        if (words["word_len_test"] == false) {
            setTitleTelugu(guess_word.length);
            document.getElementById('input').value = words["word_input"];
        } else {
            if (guess_word.length == 1) {
                setTilesTeluguForFlip(0);
                if (words["status"] === "SUCCESS") { // Win
                    submitTelugu(0);
                    setTimeout(() => {
                        jumpTiles(word_size, 1);
                    }, 500);
                } else {
                    document.getElementById('input').value = words["word_input"];
                    submitTelugu(0);
                }
            } else if (guess_word.length > 1) {
                let n = guess_word.length - 1;
                setTitleTelugu(n);
                setTilesTeluguForFlip(n);
                if (words["status"] === "SUCCESS") { // Win
                    submitTelugu(n);
                    setTimeout(() => {
                        jumpTiles(word_size, n + 1);
                    }, 500);
                } else {
                    if (guess_word.length < total_rol) {
                        document.getElementById('input').value = words["word_input"];
                    }
                    submitTelugu(n);
                }
            }
        }
    };
    const setTilesTeluguForFlip = (m) => {
        for (let j = 0; j < word_size; j++) {
            updateTilesTeluguForFlip(m, j, guess_word[m]["tlg_arr"][j], guess_word[m]["color_arr"][j]);
        }
    };
    const setTitleTelugu = (m) => {
        for (let i = 0; i < m; i++) {
            for (let j = 0; j < word_size; j++) {
                updateTilesTelugu(i, j, guess_word[i]["tlg_arr"][j], guess_word[i]["color_arr"][j])
            }
        }
    };
    const submitTelugu = (n) => {
        for (let i = 0; i < word_size; i++) {
            setTimeout(() => {
                revealTileTelugu(n, i, checkTelugu(i, n, guess_word));
            }, i * 200);
        }
    };
    const handleInput = () => {
        document.addEventListener('keydown', (e) => {
            let keypress = e.key;
            if (currentGuessCount <= total_rol) {
                if (
                    keypress.length == 1 &&
                    lettersPattern.test(e.key) &&
                    currentGuess.dataset.letters.length < word_size
                ) {
                    updateLetters(keypress, currentGuess);
                } else if (e.key == 'Backspace' && currentGuess.dataset.letters != '') {
                    deleteFromLetters(currentGuess, currentGuessCount);
                } else if (e.key == 'Enter' && currentGuess.dataset.letters.length == word_size) {
                    document.getElementById('input').value = "";
                    submitGuess();
                }
            } else {
                again();
            }
        });
    };
    const again = () => {
        var input = document.getElementById("input");
        input.remove();
        var button = document.getElementById("submit");
        button.innerHTML = "PLAY AGAIN"
        button.setAttribute('ID', 'again');
        button.setAttribute('onclick', "document.getElementById('go').click()")
    }
    const share = () => {
        var button = document.createElement("button");
        button.innerHTML = "SHARE"
        button.setAttribute('ID', 'share');
        button.setAttribute('onclick', "screenshot()")
        button.setAttribute('class', "btn btn-outline-info")
        button.setAttribute('type', "submit")
        button.setAttribute('data-toggle', "modal")
        button.setAttribute('data-target', "#ModalShare")

        document.getElementById("share_btn").appendChild(button);
    }
    if (params["language"] === "English") {
        handleInput();
    } else if (params["language"] === "Telugu") {
        teluguHandle();
    }
    const onClick = () => {
        if (currentGuessCount <= total_rol) {
            if (currentGuess.dataset.letters.length == word_size) {
                document.getElementById('input').value = "";
                submitGuess();
            }
        }
    };
    const onClickTelugu = () => {};
    const submitGuess = () => {
        for (let i = 0; i < word_size; i++) {
            setTimeout(() => {
                revealTile(i, checkLetter(i, currentGuess, solutionWord));
            }, i * 200);
        }
    };
    const checkIfGuessComplete = (i) => {
        if (i == (word_size - 1)) {
            if (solutionWord == currentGuess.dataset.letters) {
                // Win
                setTimeout(() => {
                    jumpTiles(word_size, currentGuessCount);
                }, 500);
                again();
                share();
            } else {
                // Not won
                currentGuessCount = currentGuessCount + 1;
                currentGuess = document.querySelector('#guess' + currentGuessCount);
                if (currentGuessCount == total_rol + 1) {
                    setTimeout(() => {
                        showSolution(solutionWord);
                    }, 500);
                    again();
                }
            }
        }
    };
    const revealTileTelugu = (row, col, state) => {
        flipTileTelugu(row, col, state);
    };
    const revealTile = (i, state) => {
        let tileNum = i + 1;
        flipTile(tileNum, state);
        checkIfGuessComplete(i);
    };
</script>


<br> {% endblock content %}